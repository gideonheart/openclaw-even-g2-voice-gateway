---
phase: 02-configuration-and-hardening
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - services/gateway-api/src/config-store.ts
  - services/gateway-api/src/config-store.test.ts
  - packages/validation/src/guards.ts
  - packages/validation/src/guards.test.ts
  - packages/shared-types/src/errors.ts
autonomous: true
requirements:
  - CONF-03
  - CONF-04
  - SAFE-03

must_haves:
  truths:
    - "ConfigStore wraps GatewayConfig and exposes get(), getSafe(), and update() methods"
    - "validateSettingsPatch validates each field in a partial settings payload using existing guards and branded constructors"
    - "Invalid settings input produces UserError with INVALID_CONFIG code"
    - "ConfigStore.getSafe() returns SafeGatewayConfig with all secrets masked as '********'"
    - "CORS_REJECTED and NOT_READY error codes exist in ErrorCodes"
  artifacts:
    - path: "services/gateway-api/src/config-store.ts"
      provides: "ConfigStore class and validateSettingsPatch function"
      exports: ["ConfigStore", "validateSettingsPatch"]
    - path: "services/gateway-api/src/config-store.test.ts"
      provides: "Tests for ConfigStore and validateSettingsPatch"
      min_lines: 80
    - path: "packages/validation/src/guards.ts"
      provides: "validateString guard for bounded-length string validation"
      exports: ["validateString"]
    - path: "packages/shared-types/src/errors.ts"
      provides: "CORS_REJECTED and NOT_READY error codes"
      contains: "CORS_REJECTED"
  key_links:
    - from: "services/gateway-api/src/config-store.ts"
      to: "@voice-gateway/shared-types"
      via: "imports GatewayConfig, SafeGatewayConfig, createProviderId, createSessionKey"
      pattern: "import.*GatewayConfig.*shared-types"
    - from: "services/gateway-api/src/config-store.ts"
      to: "@voice-gateway/validation"
      via: "imports validateUrl, requireNonEmpty, validatePositiveInt for settings validation"
      pattern: "import.*validation"
---

<objective>
Create the ConfigStore class (mutable config wrapper with immutable snapshots) and the settings payload validation function. These are the foundation for the POST /api/settings endpoint and all runtime configuration changes.

Purpose: Phase 2 transforms the gateway from env-only config to runtime-configurable. The ConfigStore is the single source of truth that all readers (server handlers, orchestrator, readyz) will read from. The validation function ensures all external input is validated before reaching business logic.

Output: config-store.ts with ConfigStore class and validateSettingsPatch, config-store.test.ts with full test coverage, updated guards.ts with validateString, updated errors.ts with CORS_REJECTED and NOT_READY codes.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-configuration-and-hardening/02-RESEARCH.md

@packages/shared-types/src/config.ts
@packages/shared-types/src/branded.ts
@packages/shared-types/src/errors.ts
@packages/validation/src/guards.ts
@packages/validation/src/guards.test.ts
@services/gateway-api/src/config-loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConfigStore class with TDD tests</name>
  <files>
    services/gateway-api/src/config-store.ts
    services/gateway-api/src/config-store.test.ts
    packages/shared-types/src/errors.ts
  </files>
  <action>
    **RED phase — Write failing tests first in config-store.test.ts:**

    1. Test `ConfigStore.get()` returns the initial config passed to the constructor (deep equality).
    2. Test `ConfigStore.getSafe()` masks `openclawGatewayToken` as `"********"`, `openai.apiKey` as `"********"`, and `customHttp.authHeader` as `"********"`. Verify the return type matches `SafeGatewayConfig`.
    3. Test `ConfigStore.update()` with a partial patch (e.g., `{ openclawGatewayUrl: "ws://new-url:3000" }`) and verify `get()` reflects the change while unmodified fields remain intact.
    4. Test `ConfigStore.update()` with nested provider config patches (e.g., `{ whisperx: { baseUrl: "http://new-whisperx" } }`) merges correctly without destroying sibling fields (model, language, etc.).
    5. Test `ConfigStore.update()` with an empty patch `{}` leaves config unchanged.

    Use a test fixture helper that creates a minimal valid `GatewayConfig` for tests. Import `createProviderId`, `createSessionKey` from `@voice-gateway/shared-types` to create branded values.

    **GREEN phase — Implement ConfigStore in config-store.ts:**

    Create `ConfigStore` class:
    - Constructor accepts `GatewayConfig` and stores it as private mutable state.
    - `get(): Readonly<GatewayConfig>` — returns the current config.
    - `getSafe(): SafeGatewayConfig` — returns masked config following the exact same masking pattern as the existing `handleGetSettings` in server.ts (copy the masking logic). Use `SafeGatewayConfig` type from shared-types.
    - `update(patch: ValidatedSettingsPatch): void` — applies a validated partial update. For top-level scalar fields, overwrite. For nested objects (whisperx, openai, customHttp, server), shallow-merge with spread: `{ ...this.config.whisperx, ...patch.whisperx }`. This ensures partial nested updates don't destroy sibling fields.

    Define `ValidatedSettingsPatch` as a type with all fields optional, matching the shape of `GatewayConfig` but with `Partial<>` at both top and nested levels. Export it.

    **Also add error codes to errors.ts:**
    Add `CORS_REJECTED: "CORS_REJECTED"` and `NOT_READY: "NOT_READY"` to the `ErrorCodes` object. These are needed by Plan 02 for CORS strict rejection and startup gate.

    **REFACTOR phase:** Ensure ConfigStore has no `any` types, all imports are type-safe, and the class is well-documented with JSDoc.
  </action>
  <verify>
    <automated>cd /home/forge/openclaw-even-g2-voice-gateway && npx vitest run services/gateway-api/src/config-store.test.ts --reporter=verbose</automated>
    <manual>Verify config-store.ts exports ConfigStore and ValidatedSettingsPatch. Verify errors.ts has CORS_REJECTED and NOT_READY.</manual>
  </verify>
  <done>ConfigStore class passes all 5+ tests. get() returns full config, getSafe() masks all secrets, update() handles partial top-level and nested patches correctly. CORS_REJECTED and NOT_READY error codes exist.</done>
</task>

<task type="auto">
  <name>Task 2: Create validateSettingsPatch function with TDD tests</name>
  <files>
    services/gateway-api/src/config-store.ts
    services/gateway-api/src/config-store.test.ts
    packages/validation/src/guards.ts
    packages/validation/src/guards.test.ts
  </files>
  <action>
    **RED phase — Add failing tests to config-store.test.ts:**

    1. Test `validateSettingsPatch({})` returns an empty patch (no-op update is valid).
    2. Test `validateSettingsPatch({ openclawGatewayUrl: "ws://localhost:3000" })` returns patch with validated URL.
    3. Test `validateSettingsPatch({ openclawGatewayUrl: "not-a-url" })` throws UserError with INVALID_CONFIG.
    4. Test `validateSettingsPatch({ sttProvider: "whisperx" })` returns patch with branded ProviderId.
    5. Test `validateSettingsPatch({ sttProvider: "invalid-provider" })` throws (via createProviderId).
    6. Test `validateSettingsPatch({ openclawSessionKey: "my-session" })` returns patch with branded SessionKey.
    7. Test `validateSettingsPatch({ openclawSessionKey: "" })` throws UserError.
    8. Test `validateSettingsPatch({ openclawGatewayToken: "secret-token" })` returns patch with token string (non-empty validated).
    9. Test `validateSettingsPatch({ whisperx: { baseUrl: "http://new-url" } })` validates the URL.
    10. Test `validateSettingsPatch({ whisperx: { pollIntervalMs: -1 } })` throws on non-positive integer.
    11. Test `validateSettingsPatch("not an object")` throws UserError.
    12. Test `validateSettingsPatch(null)` throws UserError.
    13. Test unknown fields are silently ignored (no throw, not included in output).

    **GREEN phase — Implement validateSettingsPatch in config-store.ts:**

    ```typescript
    export function validateSettingsPatch(body: unknown): ValidatedSettingsPatch
    ```

    Validation rules (use existing guards from @voice-gateway/validation):
    - `openclawGatewayUrl`: `validateUrl(value, "openclawGatewayUrl")`
    - `openclawGatewayToken`: `requireNonEmpty(value, "openclawGatewayToken")`
    - `openclawSessionKey`: `createSessionKey(value)` — catches TypeError, rethrows as UserError
    - `sttProvider`: `createProviderId(value)` — catches TypeError, rethrows as UserError
    - `whisperx.baseUrl`: `validateUrl(value, "whisperx.baseUrl")`
    - `whisperx.model`: `requireNonEmpty(value, "whisperx.model")`
    - `whisperx.language`: `requireNonEmpty(value, "whisperx.language")`
    - `whisperx.pollIntervalMs`: `validatePositiveInt(value, "whisperx.pollIntervalMs")`
    - `whisperx.timeoutMs`: `validatePositiveInt(value, "whisperx.timeoutMs")`
    - `openai.apiKey`: `requireNonEmpty(value, "openai.apiKey")`
    - `openai.model`: `requireNonEmpty(value, "openai.model")`
    - `openai.language`: `requireNonEmpty(value, "openai.language")`
    - `customHttp.url`: `validateUrl(value, "customHttp.url")`
    - `customHttp.authHeader`: `requireNonEmpty(value, "customHttp.authHeader")`

    The function accepts partial input — only present fields are validated. Unknown top-level fields are silently ignored (per research anti-pattern guidance: log warning, don't throw).

    Catch `TypeError` from branded constructors (`createProviderId`, `createSessionKey`) and rethrow as `UserError(ErrorCodes.INVALID_CONFIG, error.message)` so the HTTP layer returns 400, not 500.

    **Also add `validateString` to guards.ts if needed** for bounded string validation. Add corresponding test to guards.test.ts. This is optional — `requireNonEmpty` may suffice for all string fields. Only add if a distinct bounded-length check is needed.

    **REFACTOR:** Ensure validateSettingsPatch is pure (no side effects), well-typed, and all error messages include the field name for debugging.
  </action>
  <verify>
    <automated>cd /home/forge/openclaw-even-g2-voice-gateway && npx vitest run services/gateway-api/src/config-store.test.ts packages/validation/src/guards.test.ts --reporter=verbose</automated>
    <manual>Verify validateSettingsPatch handles all GatewayConfig fields listed in CONF-03 and CONF-04.</manual>
  </verify>
  <done>validateSettingsPatch passes 13+ tests covering valid input, invalid input for each field type, edge cases (null, non-object, empty), and unknown field handling. All branded type errors are caught and converted to UserError.</done>
</task>

</tasks>

<verification>
1. `npx vitest run services/gateway-api/src/config-store.test.ts --reporter=verbose` — all tests pass
2. `npx vitest run packages/validation/src/guards.test.ts --reporter=verbose` — all tests pass (including any new guards)
3. `npx tsc --noEmit` — no type errors across the workspace
4. ConfigStore.getSafe() return type matches SafeGatewayConfig (compiler-verified)
5. validateSettingsPatch rejects invalid URLs, invalid provider IDs, empty session keys, non-positive integers
6. ErrorCodes includes CORS_REJECTED and NOT_READY
</verification>

<success_criteria>
- ConfigStore class exists with get(), getSafe(), update() methods
- validateSettingsPatch validates all GatewayConfig fields using existing guards and branded constructors
- All secrets masked in getSafe() output (openclawGatewayToken, openai.apiKey, customHttp.authHeader)
- 18+ tests passing for ConfigStore and validateSettingsPatch combined
- No new external dependencies added
- TypeScript strict mode passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-configuration-and-hardening/02-01-SUMMARY.md`
</output>
